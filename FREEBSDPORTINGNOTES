bsd-devel branch

disable libcap2 checks in configure.ac
temporarily disabled gperf in build

replaced type cpu_set_t with cpuset_t in src/shared/util.h
replaced <linux/sched.h> with <sys/sched.h> in src/shared/util.c

address lack of <linux/vt.h> in src/shared/util.c
VT functions are used in vt_disallocate() and chvt(), which are then
employed in src/core/main.c and src/core/execute.c, respectively.
TODO: Replace them.
removed gettid() in ternary op

address lack of <linux/tiocl.h> in src/shared/util.c (linux kernel vconsole defs)
commented for now

<sys/inotify.h> needs to be rm'd and/or replaced with kqueue() where applicable
in util.c this is in acquire_terminal(), same function appears in tty-ask-password-agent
and src/core/execute.c

prctl() usage in util.c must be addressed

temporarily commented out <netinet/ip.h>, will address exact issues as they come up later

replaced <sys/vfs.h> with <sys/mount.h>

temporarily placed (useless on FreeBSD) TMPFS and RAMFS magic values for is_temporary_fs() function
in src/shared/util.c

src/shared/ioprio.h and src/shared/missing.h errors (__NR_ioprio_set, __NR_ioprio_get and
<linux/oom.h>)
used in src/core/execute.[ch], src/core/dbus-execute.c and src/core/load-fragment.c
(commented out until further notice)

whole bunch of undefined names in util.c ->
Removed SIGPWR due to lack of it on non-Linux
Added definitions for IPTOS_*
Replaced cpu_set_t type with cpuset_t
Removed RLIMIT_LOCKS, RLIMIT_SIGPENDING, RLIMIT_MSGQUEUE, RLIMIT_NICE,
RLIMIT_RTTIME and RLIMIT_RTPRIO (also in dbus-execute.[ch], main.c and system.conf)
Removed SCHED_IDLE and SCHED_BATCH
Define HOST_NAME_MAX as 255
Remove Linux-specific <termios.h> extensions (IUTF8 and IUCLC)
Comment out K_UNICODE
Remove O_NOATIME modifier for open() [O_NOATIME means don't alter timestamp/last modified]
Replace program_invocation_name() with getprogname()
Commented out KDSETMODE and KD_TEXT ioctl
Comment out KIOCSOUND, replace with ioctl or echo to /dev/speaker later on

<features.h> undefined in src/shared/printf.h removed

<asm/types.h> in src/shared/socket-util.h not found, these are internal
kernel typedefs, removed header

<linux/netlink.h> not found, removed

program_invocation_short_name() in log.c, replace with getprogname()
nl field has incomplete type

removed struct nl header

prctl() usage in pager.c, commented out

comment out netlink table in socket-util.c, rid of AF_NETLINK and nl union member
usages

removed socket_address_is_netlink() and socket_address_parse_netlink(),
later on address function usages in load-fragment.c and socket.c in core

<utmp.h> undefined in utmp-wtmp.c, seems absent, rm and leave
<utmpx.h> only
added definition for RUN_LVL in utmp-wtmp.h, taken from glibc
comment out ETIME, as it's Linux-specific, replace later
remove sid struct member in utmp_put_init_process(), address in execute.c later
remove code, status parameters and ut_exit struct member in utmp_put_dead_process(),
address in execute.c later
edit function declarations in utmp-wtmp.h
remove redundant utmpname() function, path's already set in FreeBSD from <paths.h>
replace updwtmpx() with pututxline()

watchdog.c uses <linux/watchdog.h>
Rid of watchdog.[ch], as they heavily rely on Linux-specific interfaces
later on: address their lack in dbus-manager.c, manager.c, shutdown.c, main.c
and test-watchdog.c

spawn-ask-password-agent.c uses <sys/prctl.h>, removed
appears to be unused
spawn-polkit-agent.c, as well, seemingly unused
hwclock.c, too

hwclock.c needs <linux/rtc.h>, try to duplicate functionality
using FreeBSD interfaces, or ignore for now
hwclock_* functions are used only in main.c and dbus-manager.c
hwclock_get_time() and hwclock_set_time() unused

time-dst.c needs <endian.h>, replace with <sys/endian.h>,
also remove <byteswap.h>

socket-label.c can't find SO_BINDTODEVICE, replace with IP_RECVIF

label.c uses <malloc.h>, instead of <stdlib.h>, replaced

ask-password-api.c uses <sys/inotify.h> and <sys/signalfd.h>
comment out relevant bits, use SCM_CREDS instead of SCM_CREDENTIALS
SO_PASSCRED undefined, comment out and replace with cmsgcred() Unix
domain socket pass, or similar later on
added <sys/ucred.h> header
replace ucred->uid check with the preferred priv_check_cred() method
(experimental)

sparse-endian.h: switched <endian.h> to <sys/endian.h>
add <sys/types.h>

dbus-common.c: epoll() usage
rid of bus_events_to_flags() and bus_flags_to_events()
remove case for ETIME
replace SO_PEERCREDS with SCM_CREDS
replace ucred->uid check with priv_check_cred()
comment out problematic assertion

_NSIG == SIGRTMIN

dbus-loop.c: remove it, as it's unused

<sys/prctl.h> in src/shared/capability.c
Where capability.h is used: src/core/execute.c,
src/core/main.c, src/shared/audit.[ch], src/tmpfiles/tmpfiles.c
related function referenced in src/core/load-fragment.c

TODO: Remove dependency on POSIX 1003.1e capabilities (in
capability.c and audit.c).
audit.h is included in selinux-access.c
edited src/core/execute.c, src/tmpfiles/tmpfiles.c, src/shared/audit.c
removed usage of have_effective_cap(), cap_last_cap()
removed usage of unused function audit_session_from_pid()
edited out capability bounding from main.c

capability.[ch] removed

selinux-access.c edited so as to not make use of
audit_loginuid_from_pid()
remove unused <sys/prctl.h> header

address <sys/epoll.h> usage in the following:
	src/core/automount.c[x],dbus.c[x],device.c[x],job.c[x],manager.c[x],
			mount.c[x],path.c[x],socket.c[x],swap.c[x],unit.c[x]

			mount.c -> commented assert(EVENTS & EPOLLIN);
			socket.c -> commented use of EPOLLIN to gauge readability
			manager.c -> ton of commenting out, replace with select() or poll()
			some time
			swap.c -> same

<linux/oom.h> usage in:
src/core/execute.c,load-fragment.c
commented out in src/shared/missing.h
done

<linux/kd.h> usage in manager.c, util.c

replaced all instances of EBADR to EBADF to denote
that unit cannot be stopped, started or reloaded

replace loops around RLIMIT_NLIMITS with int value of 16,
as seen in <linux/oom.h>

address <sys/timerfd.h> usage in:
src/core/dbus.c[x],job.c[x],manager.c[x],unit.c[x]
src/shutdownd/shutdownd.c
currently attempting to use timer_settime()
and timer_createtime() in their place, see if
it works
various errors in unit.c

address <sys/signalfd.h> usage in:
src/core/manager.c
src/ask-password/ask-password.c [appears unused]
src/reply-password/reply-password.c [x, appears unused]
src/tty-ask-password-agent/tty-ask-password-agent.c (commented)
src/shared/ask-password-api.c (commented)

<linux/seccomp-bpf.h> usage in execute.c

watchdog.h remnants:dbus-manager.c,manager.c,shutdown.c,
main.c,test-watchdog.c

manager.c -> SCM_CREDENTIALS to SCM_CREDS
comment out SO_PASSCRED usage
comment out specific RB_DISABLE_CAD (reboot disable
ctrl-alt-del, Linux-only)
add <sys/ucred.h> and paste in struct
rid of ucred->pid, unavailable here
remove manager_process_signal_fd(),
due to critical dependency on <sys/signalfd.h>
comment out some incomplete type pointer derefs,
likely due to lack of signalfd
TODO: clean this the fuck up

load-fragment.c: comment out unused prctl header
comment out <linux/fs.h>
remove config_parse_exec_capabilities, in header too
comment out capability_bounding_set
comment out some low-level __NR_* syscalls
# define MS_SLAVE (1 << 19) from <linux/fs.h>

automount.c: <linux/auto_fs4.h> and
<linux/auto_dev-ioctl.h>
remove entirely, as it uses autofs
plus dbus-automount.[ch]

mount.c: <mntent.h>
added compatibility layer

swap.c: <sys/swap.h>
commented out, appears unused

socket.c: various undeclared
socket attributes
remove AF_NETLINK conditionals
remove various missing socket options:
SO_PEERCRED/PASSCRED/PASSSEC/PRIORITY,
RCVBUFFORCE, SENDBUFFORCE, MARK, SOL_TCP
remove asprintf() check on AF_UNIX case,
which looks for ucred members not present on FreeBSD

path.c: <sys/inotify.h>
As path units are fundamentally dependent on inotify(),
we must remove them

execute.c: <sys/prctl.h>
remove apply_seccomp(), as it uses the Linux-specific
seccomp-bpf process isolation system
remove getsid() arguments in utmp_put_init_process()
and utmp_put_dead_proces()
remove Linux-specific SCHED_* flag and some <linux/fs.h>
defs

dbus.c: comment unused ev pointers, which were scrubbed
during epoll() removal
fix example SIG definition to SIGRTMIN in timer
remove bus unit path interface

dbus-execute.c: comment out PR_GET_TIMERSLACK usage
remove bus_execute_append_capabilities()

machine-id-setup.c: replace missing MS_* symbols
with equivalent MNT_* ones
added nmount(2) call to simulate Linux mount(2) semantics

mount-setup.c: consider removing entirely, though
just work around for now

loopback-setup.c: uses Linux semantics, consider removing
loopback_setup() function called in main.c and execute.c
do so

condition.c: remove test_capability()

namespace.c: <linux/fs.h>, should be removed entirely
done

switch-root.c: mount() semantics
remove entirely, linux syscall
also addressed in manager.c,dbus-manager.c,main.c
done

syscall-list.c: remove

files modified:
	src/shared/util.h
	src/shared/util.c
	src/shared/missing.h
	src/shared/ioprio.h
	src/shared/printf.h
	src/shared/socket-util.h
	src/shared/log.c
	src/shared/pager.c
	src/shared/socket-util.c
	src/shared/utmp-wtmp.c
	src/shared/utmp-wtmp.h
	[removed] src/shared/watchdog.c
	[removed] src/shared/watchdog.h
	src/shared/spawn-ask-password-agent.c
	src/shared/spawn-polkit-agent.c
	src/shared/hwclock.c
	src/shared/time-dst.c
	src/shared/socket-label.c
	src/shared/label.c
	src/shared/ask-password-api.c
	src/shared/sparse-endian.h
	src/shared/dbus-common.c
	src/shared/unit-name.c
	[removed] src/shared/dbus-loop.c
	[removed] src/shared/dbus-loop.h
	src/shared/audit.c
	src/shared/audit.h
	[removed] src/shared/capability.c
	[removed] src/shared/capability.h

	src/core/unit.h
	src/core/execute.h
	src/core/manager.h
	src/core/automount.c
	src/core/dbus-execute.c
	src/core/dbus-execute.h
	src/core/dbus-manager.c
	src/core/namespace.c
	src/core/system.conf
	src/core/dbus.c
	src/core/device.c
	src/core/job.c
	src/core/manager.c
	src/core/mount.c
	src/core/path.c
	src/core/socket.c
	src/core/service.h
	src/core/swap.c
	src/core/unit.c
	src/core/machine-id-setup.c
	src/core/mount-setup.c
	src/core/condition.c
	src/core/socket.c
	src/core/transaction.c
	src/core/execute.c
	src/core/load-fragment.c
	src/tmpfiles/tmpfiles.c
	src/core/main.c
	src/core/selinux-access.c
	[removed] src/core/automount.c
	[removed] src/core/automount.h
	[removed] src/core/dbus-automount.c
	[removed] src/core/dbus-automount.h
	[removed] src/core/path.c
	[removed] src/core/path.h
	[removed] src/core/dbus-path.c
	[removed] src/core/dbus-path.h
	[removed] src/core/loopback-setup.c
	[removed] src/core/loopback-setup.h
	[removed] src/test/test-loopback.c
	[removed] src/core/namespace.c
	[removed] src/core/namespace.h
	[removed] src/test/test-ns.c
	[removed] src/core/switch-root.c
	[removed] src/core/switch-root.h

----------

Partial list of Linux-specific interfaces in systemd:

cgroups
namespaces
selinux
autofs4
capabilities
udev
oom score adjust
RLIMIT_RTTIME
RLIMIT_RTPRIO
ionice
SCHED_RESET_ON_FORK
/proc/$PID/stat
fanotify
inotify
TIOCVHANGUP
IP_TRANSPORT
audit
F_SETPIPE_SZ
CLONE_xxx
BTRFS_IOC_DEFRAG
PR_SET_NAME
PR_CAPBSET_DROP
PR_SET_PDEATHSIG
PR_GET_SECUREBITS
/proc/$PID/comm
/proc/$PID/cmdline
/proc/cmdline
numerous GNU APIs like asprintf
SOCK CLOEXEC, O CLOEXEC
/proc/$PID/fd
/dev/tty0
TIOCLINUX
VT_ACTIVATE
TIOCNXCL
KDSKBMODE
/dev/random
/dev/char/
openat() and friends
/proc/$PID/root
waitid()
/dev/disk/by-label/
/dev/disk/by-uuid/
/sys/class/tty/console/active
/sys/class/dmi/id
/proc/$PID/cgroup
\033[3J
/dev/rtc
settimeofday() and its semantics
